<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Task 3</title>
    <style>
        body {
            background: black;
        }
       .container {
            margin: 100px auto;
            width: 500px;
            height: 500px;
            border: 1px solid gray;
            background: #4a4a4a;
       }
    </style>
</head>
<body>

<div class="container">

</div>


<script src="http://yastatic.net/d3/3.4.5/d3.js"></script>
<script>


    (function() {
        'use strict';

        /* initialisation */

        var dotNumber = 100;
        var RED_COLOR = '#FF2222';
        var YELLOW_COLOR = '#FFF666';

        var containerHeight = d3.select('.container').property('clientHeight');
        var containerWidth = d3.select('.container').property('clientWidth');
        var container = d3.select('.container')
                .append('svg')
                .attr('height', containerHeight)
                .attr('width', containerWidth);

        var coords = [];
        var mouseCoords = [-100, -100];

        container.on('mousemove', function() {
            mouseCoords = d3.mouse(this);

        });

        for (var i = 0; i < dotNumber; i++) {
            coords.push({
                cx: Math.ceil(Math.random() * (containerHeight - 10) + 5),
                cy:  Math.ceil(Math.random() * (containerWidth - 10) + 5),
                cycle: Math.ceil((Math.random() * 1000 + 1000))
            })
        }

       /* create dots */

        container.selectAll('circle')
                .data(coords)
                .enter()
                    .append('circle')
                    .attr('cx', function(data) {
                        return data.cx;
                    })
                    .attr('cy', function(data) {
                        return data.cy;
                    })
                    .attr('r', 5)
                    .attr('fill', YELLOW_COLOR);


        /* run color changer  */

        container.selectAll('circle')
                .each(function (data) {
                    changeColor(d3.select(this), data.cycle)
                });


        function changeColor(element, cycle) {
            element
                    .transition()
                    .duration(cycle / 2)
                    .attr('fill', RED_COLOR)
                    .transition()
                    .duration(cycle / 2)
                    .attr('fill', YELLOW_COLOR);

            setTimeout(function() {
                changeColor(element, cycle)
            }, cycle);
        }

       /* fluctuations */

        fluctuation();

        function fluctuation() {
            var cycle = 100;
            buildView(cycle);
            changeCoords();
            setTimeout(fluctuation, cycle)
        }

        function buildView() {

            container.selectAll('circle')
                    .data(coords)
                    .transition()
                    .attr("cx", function(d) { return d.cx; })
                    .attr("cy", function(d) { return d.cy; });

        }

        function changeCoords() {

            for (var i = 0; i < dotNumber; i++) {
                var element = coords[i];
                var elementCoordsAsArray = [element.cx, element.cy];
                defineLineFunction(mouseCoords, elementCoordsAsArray, element);

                element.cx += (Math.random() >= 0.5) ? 5 : -5;
                element.cy += (Math.random() >= 0.5) ? 5 : -5;
            }
        }


        function defineLineFunction(dot1, dot2, element) {
            // координаты мыши
            var x1 = dot1[0];
            var y1 = dot1[1];
            // координаты центра элемента
            var x2 = dot2[0];
            var y2 = dot2[1];
            // требуемое расстояние между мышью и элементом
            var maxDistance = 150;

            // найдем расстояние центра элемента от положения мыши
            var currentDistance = Math.sqrt( (x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2) );

            if  (currentDistance > 100) {
                return;
            }

            // найдем расстояние на которое нужно переместить элемент
            var movedDistance = maxDistance - currentDistance;

            var cosA = (x1 - x2) / currentDistance;
            var x3 = x1 - cosA * movedDistance;

            var cosB = (y1 - y2) / currentDistance;
            var y3 = y1 - cosA * movedDistance;

            element.cx = x3;
            element.cy = y3;
            console.log(element);
        }

    })();
</script>
</body>
</html>