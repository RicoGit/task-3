<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Task 3</title>
    <style>
        body {
            background: black;
        }
       .container {
            margin: 100px auto;
            width: 512px;
            height: 512px;
            border: 1px solid gray;
            background: #4a4a4a;
       }
       .container svg {
           width: inherit;
           height: inherit;
       }
    </style>
</head>
<body>

<div class="container">

</div>


<script src="http://yastatic.net/d3/3.4.5/d3.js"></script>
<script>


    (function() {
        'use strict';


        // константы
        var DOT_NUMBER = 8;
        var FIELD_SIZE = 512;
        var RED_COLOR = '#FF2222';
        var YELLOW_COLOR = '#FFF666';
        var CIRCLE_RADIUS = 64;
        //колличество ячеек в поле
        var BOX_NUMBER = FIELD_SIZE / (CIRCLE_RADIUS * 2);
        // вектор всевозможных координат
        var VECTOR = [];

        //таблица координат
        var coords = [];
        var container = d3.select('.container').append('svg');


        //заполняем матрицу координатами

        for (var x = 0; x < BOX_NUMBER; x++) {
            for (var y = 0; y < BOX_NUMBER; y++) {
                VECTOR[ getNumber(x, y) ] = {
                    x: CIRCLE_RADIUS  + (x * CIRCLE_RADIUS * 2),
                    y: CIRCLE_RADIUS  + (y * CIRCLE_RADIUS * 2),
                    siblings: getSibling(x, y)
                };
            }
        }


        function getSibling(x, y) {
            var result = [];
            if (x < BOX_NUMBER - 1) {
                result.push(getNumber(x + 1, y))
            }
            if (x > 0) {
                result.push(getNumber(x - 1, y))
            }
            if (y < BOX_NUMBER - 1) {
                result.push(getNumber(x, y + 1))
            }
            if (y > 0) {
                result.push(getNumber(x, y - 1))
            }
            return result;
        }

        function getNumber(x, y) {
            return (x * BOX_NUMBER + y);
        }

        var VECTOR_SIZE = VECTOR.length - 1;

        // распределяем точки по матрице

        for (var i = 0; i < DOT_NUMBER; i++) {
            coords[i] = {
                boxNumber: getFreeBoxNumber()
            };
        }

        function getFreeBoxNumber() {
            var randomFreeNumber = Math.round(Math.random() * VECTOR_SIZE);
            if  (randomFreeNumber in coords) {
                getFreeBoxNumber();
            }
            return randomFreeNumber;
        }


        // рисуем точки

        container.selectAll('circle')
                .data(coords)
                .enter()
                .append('circle')
                .attr('cx', function(data) {
                    return VECTOR[data.boxNumber].x;
                })
                .attr('cy', function(data) {
                    return VECTOR[data.boxNumber].y;
                })
                .attr('r', CIRCLE_RADIUS);


        // добавляем анимацию сменя цвета

        d3.selectAll('circle')
                .each(function() {
                    //change color cycle between 1s and 1.5s
                    var cycle = (Math.random() * 1000 + 1000);
                    changeColor(this, cycle);
                });

        function changeColor(element, cycle) {

            d3.select(element)
                    .style('fill', YELLOW_COLOR)
                    .transition()
                    .duration(cycle / 2)
                    .style('fill', RED_COLOR)
                    .transition()
                    .duration(cycle / 2)
                    .style('fill', YELLOW_COLOR);

            setTimeout(function() {
                changeColor(element, cycle)
            }, cycle);
        }

        // добавляем колемания

        fluctuation();

        function fluctuation() {

            var circle = container.selectAll('circle')
                    .data(coords);

            circle
                    .transition()
                    .duration(100)
                    .attr("cx", function(data, i) {
                        data.boxNumber = findFreeBoxNumber(data);
                        coords[i] = {boxNumber: data.boxNumber};
                        return VECTOR[ data.boxNumber ].x;
                    })
                    .attr("cy", function(data,i) {
                        data.boxNumber = findFreeBoxNumber(data);
                        coords[i] = {boxNumber: data.boxNumber};
                        return VECTOR[ data.boxNumber ].y;
                    });
            setTimeout(fluctuation, 500)
        }




        function findFreeBoxNumber(data) {
            var siblings = [].concat(VECTOR[data.boxNumber].siblings);
            do {
                var randomElement = getRandomElement(siblings);
                siblings.splice(siblings.indexOf(randomElement), 1);
            } while (check(randomElement));
            return  randomElement;
        }

        function check(randomElement) {
            for (var i = 0; i < coords.length; i++) {
                var coord = coords[i];
                return coord.boxNumber == randomElement;
            }

        }

        function getRandomElement(array) {
            var random = Math.round(Math.random() * (array.length - 1));
            return array[random];
        }

    })();
</script>
</body>
</html>